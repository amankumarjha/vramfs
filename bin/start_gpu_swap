#!/usr/bin/env bash
# Idempotent starter for GPU-backed NBD swap (non-blocking)
set -euo pipefail

PORT=${PORT:-10809}
NBD_DEVICE=${NBD_DEVICE:-/dev/nbd1}
PLUGIN=${PLUGIN:-$(pwd)/bin/nbdkit_cuda_plugin.so}
LOG=${LOG:-/tmp/vramswap_nbdkit.log}

log() { echo "$(date -Is) [start_gpu_swap] $*" | tee -a "$LOG"; }

if [ ! -f "$PLUGIN" ]; then
  echo "$(date -Is) [start_gpu_swap] ERROR: plugin $PLUGIN not found" | tee -a "$LOG" >&2
  exit 2
fi

# Ensure the log file exists and is writable. Use sudo to create/change perms
# so the script can be run as a non-root user which later invokes sudo.
if [ ! -e "$LOG" ]; then
  sudo sh -c "touch '$LOG'" || true
  sudo sh -c "chmod a+rw '$LOG'" || true
fi
if [ ! -w "$LOG" ]; then
  sudo sh -c "chmod a+rw '$LOG'" || true
fi

log "Starting nbdkit with plugin $PLUGIN on port $PORT"
# start nbdkit (run as current user). Allow passing plugin options via PLUGIN_ARGS.
# Redirect output to logfile which we've ensured is writable.
nohup nbdkit -f -v -p ${PORT} "$PLUGIN" ${PLUGIN_ARGS:-} >>"$LOG" 2>&1 &

log "Waiting for nbdkit to listen on port $PORT"
for i in {1..50}; do
  ss -ltn | grep -q ":${PORT}" && break
  sleep 0.1
done
ss -ltn | grep -q ":${PORT}" || { log "nbdkit did not start"; exit 1; }

log "Loading nbd kernel module and attaching $NBD_DEVICE"
# If the device is already used as swap, disable it first so we can reattach.
if sudo swapon --show=NAME --noheadings | grep -qx "$NBD_DEVICE"; then
  log "Detected $NBD_DEVICE already active as swap â€” running swapoff"
  sudo swapoff "$NBD_DEVICE" >>"$LOG" 2>&1 || true
fi
# If qemu-nbd left a previous connection, disconnect it to avoid attach failures.
sudo qemu-nbd --disconnect ${NBD_DEVICE} >/dev/null 2>&1 || true
sudo modprobe nbd max_part=8
sudo qemu-nbd --format=raw --persistent --connect=${NBD_DEVICE} nbd://127.0.0.1:${PORT} >>"$LOG" 2>&1

log "Waiting for device ${NBD_DEVICE} and valid size"
for i in {1..50}; do
  [ -b "$NBD_DEVICE" ] || { sleep 0.1; continue; }
  size=$(sudo blockdev --getsize64 "$NBD_DEVICE" 2>/dev/null || echo 0)
  [ "$size" -gt 65536 ] && break
  sleep 0.1
done
size=$(sudo blockdev --getsize64 "$NBD_DEVICE" 2>/dev/null || echo 0)
[ "$size" -gt 65536 ] || { log "device $NBD_DEVICE has invalid size ($size)"; exit 1; }

log "Creating swap on $NBD_DEVICE"
sudo file -s "$NBD_DEVICE" | tee -a "$LOG"
sudo mkswap -f "$NBD_DEVICE" | tee -a "$LOG"
sudo swapon -p 1 "$NBD_DEVICE" | tee -a "$LOG"

log "Swap enabled"
sudo swapon --show | tee -a "$LOG"

log "start_gpu_swap completed"
exit 0
